<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Gym Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      color-scheme: light dark;
    }

    body {
      margin: 0;
      padding: 1rem;
      background: #f3f4f6;
      color: #111827;
    }

    .app {
      max-width: 720px;
      margin: 0 auto 2rem;
    }

    header {
      margin-bottom: 0.75rem;
    }

    header h1 {
      font-size: 1.4rem;
      margin: 0 0 0.2rem;
    }

    header p {
      margin: 0;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 0.9rem 1rem;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
      margin-bottom: 0.9rem;
    }

    label {
      font-size: 0.8rem;
      font-weight: 500;
      display: block;
      margin-bottom: 0.15rem;
      color: #374151;
    }

    input,
    select {
      width: 100%;
      padding: 0.45rem 0.6rem;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      box-sizing: border-box;
      font-size: 0.9rem;
      background: #f9fafb;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
      background: #ffffff;
    }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem;
    }

    .exercise-card {
      margin-bottom: 0.75rem;
      padding: 0.75rem 0.85rem;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .exercise-card h3 {
      margin: 0 0 0.1rem;
      font-size: 1rem;
      font-weight: 600;
    }

    .exercise-tempo {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 0.35rem;
    }

    .set-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.3rem 0.75rem;
      margin-top: 0.45rem;
      padding-top: 0.35rem;
      border-top: 1px dashed #e5e7eb;
    }

    .set-title {
      font-size: 0.78rem;
      font-weight: 600;
      color: #4b5563;
      grid-column: 1 / -1;
    }

    .note-field {
      grid-column: 1 / -1;
    }

    .note-field input {
      font-size: 0.85rem;
    }

    .buttons-row {
      display: flex;
      gap: 0.6rem;
      margin: 0.7rem 0 1rem;
    }

    .buttons-row button {
      flex: 1;
      padding: 0.6rem 0.8rem;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
    }

    .primary-btn {
      background: #2563eb;
      color: #ffffff;
    }

    .secondary-btn {
      background: #e5e7eb;
      color: #111827;
    }

    .primary-btn:active,
    .secondary-btn:active {
      transform: scale(0.98);
    }

    h2 {
      font-size: 1.05rem;
      margin: 0 0 0.4rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th,
    td {
      border-bottom: 1px solid #e5e7eb;
      padding: 0.25rem 0.3rem;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      color: #4b5563;
    }

    @media (max-width: 600px) {
      body {
        padding: 0.5rem;
      }

      .card {
        padding: 0.8rem 0.8rem;
      }

      .config-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      .buttons-row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Gym Tracker</h1>
      <p>Traccia i tuoi progressi per i 3 allenamenti (2 serie per esercizio).</p>
    </header>

    <!-- Configurazione giorno + allenamento -->
    <section class="card">
      <div class="config-grid">
        <div>
          <label for="dateInput">Data</label>
          <input type="date" id="dateInput" />
        </div>
        <div>
          <label for="workoutSelect">Allenamento</label>
          <select id="workoutSelect"></select>
        </div>
      </div>
    </section>

    <!-- Esercizi dinamici -->
    <section class="card">
      <h2>Esercizi</h2>
      <div id="exercisesContainer"></div>
    </section>

    <!-- Bottoni azione -->
    <div class="buttons-row">
      <button id="saveWorkoutBtn" class="primary-btn">Salva allenamento</button>
      <button id="exportCsvBtn" class="secondary-btn">Esporta CSV</button>
    </div>

    <!-- Storico -->
    <section class="card">
      <h2>Storico</h2>
      <div id="history"></div>
    </section>
  </div>

  <script>
    // === DATI ALLENAMENTI (dal PDF) ===
    const WORKOUTS = [
      {
        id: 'A1',
        name: 'Allenamento 1',
        exercises: [
          { id: 'a1_curl_gomiti', name: 'Curl con gomiti appoggiati', tempo: '3111' },
          { id: 'a1_alzate_y', name: 'Alzate ad Y manubri su panca', tempo: '2112' },
          { id: 'a1_pullover', name: 'Pullover petto e tricipiti', tempo: '3111' },
          { id: 'a1_pressa_quad', name: 'Pressa focus quadricipiti', tempo: '3211' },
          { id: 'a1_leg_curl', name: 'Leg curl sdraiato', tempo: '3112' },
          { id: 'a1_pulley_upper', name: 'Pulley per upper back gomiti stretti', tempo: '3112' },
          { id: 'a1_polpacci', name: 'Polpacci alla pressa a una gamba', tempo: '3511' },
          { id: 'a1_crunch_panca', name: 'Crunch su panca', tempo: '3112' }
        ]
      },
      {
        id: 'A2',
        name: 'Allenamento 2',
        exercises: [
          { id: 'a2_spinte_70', name: 'Spinte panca 70° al multipower (spalle)', tempo: '3211' },
          { id: 'a2_estensioni_tric', name: 'Estensioni su panca inclinata per tricipiti', tempo: '3111' },
          { id: 'a2_curl_cavo', name: 'Curl al cavo tra le gambe', tempo: '2211' },
          { id: 'a2_polpacci_pressa', name: 'Polpacci alla pressa', tempo: '3511' },
          { id: 'a2_pec_deck', name: 'Pec Deck / Pec Fly', tempo: '3111' },
          { id: 'a2_leg_curl_una', name: 'Leg curl sdraiato a una gamba', tempo: '3112' },
          { id: 'a2_crunch_cavo', name: 'Crunch al cavo', tempo: '3112' }
        ]
      },
      {
        id: 'A3',
        name: 'Allenamento 3',
        exercises: [
          { id: 'a3_spinte_1530', name: 'Spinte petto su panca 15–30°', tempo: '3111' },
          { id: 'a3_pushdown', name: 'Pushdown a braccio singolo', tempo: '3111' },
          { id: 'a3_curl_martello', name: 'Curl a martello con gomiti appoggiati', tempo: '3111' },
          { id: 'a3_alzate_laterali_cavo', name: 'Alzate laterali braccio singolo al cavo basso', tempo: '3111' },
          { id: 'a3_leg_extension', name: 'Leg extension (unilaterale)', tempo: '3112' },
          { id: 'a3_iperestensioni', name: 'Iperestensioni 45° femorali', tempo: '3111' },
          { id: 'a3_pulley_upper', name: 'Pulley per upper back', tempo: '3112' },
          { id: 'a3_stiff_arm', name: 'Stiff arm pulldown su panca', tempo: '3112' }
        ]
      }
    ];

    const STORAGE_KEY = 'gymEntries_v2';
    let entries = [];

    function loadData() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) {
        entries = [];
        return;
      }
      try {
        entries = JSON.parse(saved) || [];
      } catch (e) {
        entries = [];
      }
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }

    function populateWorkoutSelect() {
      const select = document.getElementById('workoutSelect');
      WORKOUTS.forEach((w) => {
        const opt = document.createElement('option');
        opt.value = w.id;
        opt.textContent = w.name;
        select.appendChild(opt);
      });
    }

    function getWorkoutById(id) {
      return WORKOUTS.find((w) => w.id === id) || WORKOUTS[0];
    }

    function renderExercises() {
      const container = document.getElementById('exercisesContainer');
      const workoutId = document.getElementById('workoutSelect').value;
      const workout = getWorkoutById(workoutId);

      container.innerHTML = '';

      workout.exercises.forEach((ex) => {
        const card = document.createElement('div');
        card.className = 'exercise-card';
        card.dataset.exerciseId = ex.id;
        card.dataset.exerciseName = ex.name;

        const title = document.createElement('h3');
        title.textContent = ex.name;

        const tempo = document.createElement('div');
        tempo.className = 'exercise-tempo';
        tempo.textContent = 'Tempo: ' + ex.tempo;

        card.appendChild(title);
        card.appendChild(tempo);

        // 2 serie per ogni esercizio
        for (let setIndex = 1; setIndex <= 2; setIndex++) {
          const row = document.createElement('div');
          row.className = 'set-row';
          row.dataset.setIndex = String(setIndex);

          const setLabel = document.createElement('div');
          setLabel.className = 'set-title';
          setLabel.textContent = 'Serie ' + setIndex;
          row.appendChild(setLabel);

          // Peso
          const pesoWrap = document.createElement('div');
          const pesoLabel = document.createElement('label');
          pesoLabel.textContent = 'Peso (kg)';
          const pesoInput = document.createElement('input');
          pesoInput.type = 'number';
          pesoInput.step = '0.5';
          pesoInput.inputMode = 'decimal';
          pesoInput.className = 'peso-input';
          pesoWrap.appendChild(pesoLabel);
          pesoWrap.appendChild(pesoInput);

          // Ripetizioni
          const repsWrap = document.createElement('div');
          const repsLabel = document.createElement('label');
          repsLabel.textContent = 'Ripetizioni';
          const repsInput = document.createElement('input');
          repsInput.type = 'number';
          repsInput.inputMode = 'numeric';
          repsInput.className = 'reps-input';
          repsWrap.appendChild(repsLabel);
          repsWrap.appendChild(repsInput);

          row.appendChild(pesoWrap);
          row.appendChild(repsWrap);

          // Note
          const noteWrap = document.createElement('div');
          noteWrap.className = 'note-field';
          const noteLabel = document.createElement('label');
          noteLabel.textContent = 'Note';
          const noteInput = document.createElement('input');
          noteInput.type = 'text';
          noteInput.className = 'note-input';
          noteInput.placeholder = 'Sensazioni, RPE, buffer...';
          noteWrap.appendChild(noteLabel);
          noteWrap.appendChild(noteInput);

          row.appendChild(noteWrap);
          card.appendChild(row);
        }

        container.appendChild(card);
      });
    }

    function renderHistory() {
      const container = document.getElementById('history');
      if (!entries.length) {
        container.textContent = 'Nessun allenamento salvato.';
        return;
      }

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML =
        '<tr><th>Data</th><th>Allenamento</th><th>Esercizio</th><th>Serie</th><th>Peso</th><th>Rep</th><th>Note</th></tr>';
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      // Mostra prima le serie più recenti
      entries
        .slice()
        .reverse()
        .forEach((e) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${e.date}</td>
            <td>${e.workoutName}</td>
            <td>${e.exerciseName}</td>
            <td>${e.set}</td>
            <td>${e.weight ?? ''}</td>
            <td>${e.reps ?? ''}</td>
            <td>${e.notes ? e.notes : ''}</td>
          `;
          tbody.appendChild(tr);
        });

      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }

    function clearFormInputs() {
      document
        .querySelectorAll('.exercise-card .peso-input, .exercise-card .reps-input, .exercise-card .note-input')
        .forEach((inp) => (inp.value = ''));
    }

    function saveWorkout() {
      const dateInput = document.getElementById('dateInput');
      let dateStr = dateInput.value;

      if (!dateStr) {
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, '0');
        const d = String(today.getDate()).padStart(2, '0');
        dateStr = `${y}-${m}-${d}`;
        dateInput.value = dateStr;
      }

      const workoutSel = document.getElementById('workoutSelect');
      const workoutId = workoutSel.value;
      const workout = getWorkoutById(workoutId);

      const cards = document.querySelectorAll('.exercise-card');
      const newEntries = [];

      cards.forEach((card) => {
        const exerciseId = card.dataset.exerciseId;
        const exerciseName = card.dataset.exerciseName;
        const rows = card.querySelectorAll('.set-row');

        rows.forEach((row) => {
          const setIndex = parseInt(row.dataset.setIndex, 10);
          const pesoInput = row.querySelector('.peso-input');
          const repsInput = row.querySelector('.reps-input');
          const noteInput = row.querySelector('.note-input');

          const pesoVal = pesoInput.value.trim();
          const repsVal = repsInput.value.trim();
          const notesVal = noteInput.value.trim();

          // Se è completamente vuota, salta
          if (!pesoVal && !repsVal && !notesVal) {
            return;
          }

          const weight = pesoVal ? parseFloat(pesoVal.replace(',', '.')) : null;
          const reps = repsVal ? parseInt(repsVal, 10) : null;

          if ((pesoVal && isNaN(weight)) || (repsVal && isNaN(reps))) {
            return; // scarta input non validi
          }

          newEntries.push({
            date: dateStr,
            workoutId,
            workoutName: workout.name,
            exerciseId,
            exerciseName,
            set: setIndex,
            weight,
            reps,
            notes: notesVal
          });
        });
      });

      if (!newEntries.length) {
        alert('Compila almeno una serie prima di salvare.');
        return;
      }

      entries = entries.concat(newEntries);
      saveData();
      clearFormInputs();
      renderHistory();
      alert('Allenamento salvato ✅');
    }

    function exportCsv() {
      if (!entries.length) {
        alert('Non ci sono dati da esportare.');
        return;
      }

      const header = ['Data', 'Allenamento', 'Esercizio', 'Serie', 'Peso', 'Ripetizioni', 'Note'];
      const rows = entries.map((e) => [
        e.date,
        e.workoutName,
        e.exerciseName,
        e.set,
        e.weight ?? '',
        e.reps ?? '',
        e.notes || ''
      ]);

      const csvLines = [header, ...rows].map((row) =>
        row.map((field) => `"${String(field).replace(/"/g, '""')}"`).join(',')
      );
      const csvContent = csvLines.join('\r\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'gym_tracker_history.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadData();
      populateWorkoutSelect();

      // Data di default = oggi
      const dateInput = document.getElementById('dateInput');
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const d = String(today.getDate()).padStart(2, '0');
      dateInput.value = `${y}-${m}-${d}`;

      renderExercises();
      renderHistory();

      document.getElementById('workoutSelect').addEventListener('change', () => {
        renderExercises();
        clearFormInputs();
      });

      document.getElementById('saveWorkoutBtn').addEventListener('click', saveWorkout);
      document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
    });
  </script>
</body>
</html>
